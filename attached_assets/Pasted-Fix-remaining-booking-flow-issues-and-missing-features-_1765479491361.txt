Fix remaining booking flow issues and missing features. Do not change visual design (only functional/logic changes, small UX copy changes allowed). Implement the following items so clicking a bus:

• opens a pickup-point modal for the source city,
• then opens a drop-point modal for the destination city,
• then opens the seat-selection/booking page for that trip with pickup/drop params,
• booking confirmation sends a detailed email to the user,
• booking page route must exist (no 404),
• capture user gender (male/female/other) at login/profile.

Make code changes as described below. Return the list of changed/created files and a short test log showing required console output.

--- A. Ensure booking route exists & booking page wiring
1. Verify React Router has a route for `/booking/:id` (or create it).
   - File: `client/src/App.tsx` or wherever routes are declared.
   - Add route: `<Route path="/booking/:id" element={<BookingPage />} />`
   - If your project uses pages folder routing, ensure file `client/src/pages/booking/[id].tsx` or `client/src/pages/booking.tsx` exists and is exported in router.

2. Create/Update Booking Page
   - Path: `client/src/pages/booking/[id].tsx` (create if missing).
   - Behavior:
     • Read route param `id` and query params `?pickup=<id>&drop=<id>`.
     • If `pickup` or `drop` query params are missing, immediately show pickup modal flow (see B).
     • If both present, show seat map and "Confirm Booking" panel (existing seat selection UI may be reused).
     • When user confirms seats, call the booking API (see section D).
   - Add console.log lines:
     `console.log('BOOKING PAGE LOAD', { tripId, pickup, drop })`

--- B. Pickup → Drop modal flow (two-step)
1. Create `client/src/components/PickupModal.tsx`
   - Props: `{ open: boolean, onClose: ()=>void, trip, onSelect: (pickupPoint)=>void }`
   - UI: list pickup points (trip.pickup_points), fallback to sample points if absent.
   - On select: `console.log('PICKUP SELECTED', selected); onSelect(selected);`
2. Create `client/src/components/DropModal.tsx`
   - Props: `{ open, onClose, trip, onSelect }`
   - UI: list drop points (trip.drop_points).
   - On select: `console.log('DROP SELECTED', selected); onSelect(selected);`
3. Integrate into list card `View Seats` click handling:
   - When user clicks "View Seats":
     • If not logged in: launch login OTP then continue.
     • Open `PickupModal`. After selection, open `DropModal`. After selection, navigate to `/booking/:id?pickup=<p.id>&drop=<d.id>`.

--- C. sampleTrips update (client-side fallback)
1. Update `client/src/data/sampleTrips.ts` (or create) to ensure each trip has:
   - `id`, `operator`, `source`, `destination`, `date` (YYYY-MM-DD), `departure`, `arrival`, `price`, `seatsTotal`, and arrays:
     ```
     pickup_points: [{ id:'p1', label:'Central Bus Stand, Mumbai' }, ...],
     drop_points:   [{ id:'d1', label:'Majestic Bus Stop, Bengaluru' }, ...]
     ```
2. Keep prices in INR numbers.

--- D. Backend booking endpoint + transactional seat allocation + email
1. Create/update booking route:
   - Path: `server/src/routes/bookings.js` (or server equivalent) and mount at `/api/bookings`.
   - Endpoint: `POST /api/bookings`
   - Request body:
     ```
     { tripId, userId, seats: [ 'L2A', ... ], pickupPointId, dropPointId, amount, currency: 'INR' }
     ```
2. Implementation details (Express + PostgreSQL):
   - Use a DB transaction.
   - Lock seat rows / trip row with `SELECT ... FOR UPDATE` before updating seat availability.
   - Verify requested seats are still available; if not, return 409 with message "Seats no longer available".
   - Insert booking row into `bookings` table with booking reference id (UUID).
   - Insert booking seat rows.
   - Commit transaction.
   - After commit, call `sendBookingConfirmationEmail(userEmail, bookingObject)` (see E).
   - Response: `201 { booking }`.

3. Add logging:
   - `console.log('BOOKING CONFIRMED', booking.id)` on success
   - `console.log('Sent booking confirmation to', userEmail)` after email send.

--- E. Booking confirmation email (backend)
1. Add helper in `server/src/lib/mail.js`:
   - `async function sendBookingConfirmationEmail(to, booking)` which sends a well-formatted HTML email containing:
     • Booking ref id
     • User email/name/gender (if available)
     • Trip operator
     • Date (YYYY-MM-DD)
     • Departure time & pickup label
     • Arrival time & drop label
     • Seat numbers
     • Amount (formatted INR)
     • Link to frontend booking details (use `process.env.FRONTEND_URL`).
2. Use existing SMTP (Gmail) helper you already integrated.
3. Ensure the backend logs success/failure.

--- F. Frontend booking confirmation flow
1. In `client/src/pages/booking/[id].tsx`, on successful POST `/api/bookings`:
   - Show success modal: "Booking confirmed — confirmation sent to <user email>"
   - Redirect to `/my-trips` or booking details page.
   - Console.log `'BOOKING CONFIRMED', booking.id` (from response).

--- G. Capture user gender in login/profile
1. Database: make `users.gender` nullable but accept values `male`, `female`, `other`.
2. Frontend: in login/profile modal (after OTP verify), if user record has no gender, prompt small inline field (select) to capture gender before allowing booking.
   - Example flow: after first login, show a modal "Tell us your gender (optional)" with select Male/Female/Other and Save. Save via `PATCH /api/users/:id`.
3. Backend: accept and persist `gender` in users table.

--- H. Fix timezone/date off-by-one (ensure local date compare)
1. Ensure frontend uses `toLocalISO(date)` helper to produce `YYYY-MM-DD`.
2. Ensure backend filtering compares `date_iso` column (YYYY-MM-DD) to the incoming date string.

--- I. Error handling & UX
1. If booking fails (seats unavailable), show error modal and suggest similar alternatives.
2. If email sending fails, still return 201 booking success but log email failure and show toast: "Booking confirmed; email sending failed — please check My Trips."

--- J. Tests / Acceptance Criteria (required)
1. Click a bus card → Pickup modal appears → select pickup → Drop modal appears → select drop → navigate to booking page with pickup/drop query params.
   - Console must show:
     ```
     PICKUP SELECTED { id: 'p1', label: '...' }
     DROP SELECTED { id: 'd1', label: '...' }
     BOOKING PAGE LOAD { tripId: '1', pickup: 'p1', drop: 'd1' }
     ```
2. Select seats and confirm booking → backend must log `BOOKING CONFIRMED <bookingId>` and `Sent booking confirmation to <email>` and user receives booking email.
3. If email fails, backend logs error and front shows fallback message but booking should still be created.
4. The `/booking/:id` route must NOT 404. Loading `/booking/1` directly should render the booking page (show message if trip not found).
5. After first OTP login, if user has no gender, prompt to save gender before booking. `PATCH /api/users/:id` must persist gender.

--- K. Files to change/create (agent must return this list)
Client:
- client/src/pages/booking/[id].tsx (CREATE/UPDATE)
- client/src/components/PickupModal.tsx (CREATE)
- client/src/components/DropModal.tsx (CREATE)
- client/src/data/sampleTrips.ts (UPDATE)
- client/src/pages/home.tsx (UPDATE: ensure "View Seats" flow triggers pickup/drop)
- client/src/pages/my-trips.tsx (ensure booking list reflects new booking)
- client/src/utils/dateLocal.ts (CREATE)
- client/src/components/GenderPromptModal.tsx (CREATE) - optional small modal to capture gender

Server:
- server/src/routes/bookings.js (CREATE/UPDATE)
- server/src/controllers/bookings.js (CREATE/UPDATE)
- server/src/lib/mail.js (UPDATE: add sendBookingConfirmationEmail)
- server/src/migrations/* (UPDATE: add bookings table and date_iso field if needed)
- server/src/routes/users.js (UPDATE: add PATCH to update gender)

--- L. Developer notes & safety
- Use database transactions with `SELECT ... FOR UPDATE` to prevent double-booking.
- Send confirmation email asynchronously after booking commit; if it fails, log the error.
- Keep console logs for test verification; remove excessive debug later.
- Use `process.env.FRONTEND_URL` to build links in emails (fail-safe to `http://localhost:3000` if missing).

--- M. Deliverables after work completes
1. Return exact changed/created file list (paths).
2. Provide console log snippet showing: `PICKUP SELECTED`, `DROP SELECTED`, `BOOKING PAGE LOAD`, `BOOKING CONFIRMED` and `Sent booking confirmation to <email>`.
3. Provide one screenshot of pickup modal and one screenshot of booking confirmation toast or success modal.
4. If any runtime errors occur during implementation, return the full stack trace immediately.

Start now and implement these changes. If any single part cannot be implemented due to environment constraints, report it clearly and implement available parts with fallback behavior.
