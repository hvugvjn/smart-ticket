Implement Route Map Visualization + Skeleton Loaders + Live Tracking on the booking page.

High-level goals

Show a mini map on the booking page with Pickup → Drop markers, intermediate stops highlighted, and a route polyline.

Add a “Track my bus live” button near the map that opens a map overlay and starts live-tracking the bus position (simulated if no real GPS).

Replace blank waits with skeleton loaders while data loads.

Keep visual design consistent — small, minimal markup/CSS changes only.

Libraries to install

react-leaflet and leaflet

npm install react-leaflet leaflet

(Optional) clsx for small class helper if missing

Files to create / update

client/src/components/MapMini.tsx — new React component that renders the Leaflet mini map (pickup → drop → stops).

client/src/components/LiveMapOverlay.tsx — modal/overlay map used by “Track my bus live”. Includes simulated live position updates.

client/src/components/SkeletonLoader.tsx — small reusable skeleton loader component (CSS-based).

client/src/pages/booking/[id].tsx (or client/src/pages/booking.tsx) — update to:

Import and render MapMini inside the booking details card.

Show SkeletonLoader while booking/trip data is loading.

Add the Track my bus live button that opens LiveMapOverlay.

server/src/routes/track.ts (or server/api/track.ts) — add a small simulated endpoint:

GET /api/track/:tripId returns a stream / polling endpoint or returns simulated coordinates and intermediate stops if realtime not available.

Provide an optional SSE endpoint /api/track/:tripId/sse (if SSE already supported) OR /api/track/:tripId/positions which returns JSON array or next position.

client/src/lib/api.ts — add functions getTripStops(tripId) and getLivePosition(tripId) (polling) used by the LiveMapOverlay.

Any CSS file (e.g., client/src/styles/map.css) for leaflet container and skeleton styling.

Implementation details (copy this exact text to the agent as instructions)
MapMini.tsx

Path: client/src/components/MapMini.tsx

Behavior:

Props: { pickup: {lat, lng, name}, drop: {lat,lng,name}, stops: Array<{lat,lng,name}>, zoom?: number }

Show a small Leaflet map (fixed height ~ 220px, full width).

Add markers:

Pickup marker (icon pin, popup with name).

Drop marker (different color).

Stops as small circle markers with label.

Add a polyline connecting pickup → stops → drop.

Fit map bounds to show whole route.

Minimal controls: disable zoomControl on mini map, make it non-interactive on small screens but interactive when hovered (use dragging: false for initial load, then enable on click).

Accessibility:

Add role="application" on the map wrapper and aria-label="Route map".

LiveMapOverlay.tsx

Path: client/src/components/LiveMapOverlay.tsx

Behavior:

Props: { tripId, initialPosition?, onClose }

Opens as modal overlay centered on screen (full-screen on mobile, centered on desktop).

Renders larger Leaflet map with:

The full route polyline.

Pickup / Drop markers and stops.

A highlighted bus marker representing the current position.

Live tracking:

If server SSE available: subscribe to /api/track/:tripId/sse.

Otherwise: poll /api/track/:tripId/positions?last=<ts> every 2s, updating marker smoothly.

Provide a small status UI: Connected / Polling and last update time.

Provide Start / Stop tracking buttons and a small speed toggle (simulate 1x/2x).

Provide a button to center the map on the bus.

Console.log every new position for testability.

Accessibility:

Ensure modal is keyboard-focusable and closable by ESC.

SkeletonLoader.tsx

Path: client/src/components/SkeletonLoader.tsx

Behavior:

Small component that accepts height, width, variant props and renders animated gray block(s).

Use CSS keyframe shimmer effect.

Replace blank waits on booking page: while booking/trip/route/stops are loading, show skeleton placeholders where the map and trip details would appear.

API & Server changes (simulate if needed)

Client helper:

client/src/lib/api.ts:

async function getTripStops(tripId): calls /api/trips/:tripId/stops or fallback to mock.

async function getLivePosition(tripId): returns latest position object {lat, lng, ts} from /api/track/:tripId/positions.

Server endpoint (if you can modify server):

Add GET /api/track/:tripId/positions that returns JSON with incremental positions (simulate movement along route).

Example reply:

{ "tripId": "1", "positions": [
  { "lat": 19.07598, "lng": 72.87766, "ts": 1700000000 },
  { "lat": 19.08000, "lng": 72.90000, "ts": 1700000010 }
] }


Accept query ?since=<ts> to return only new positions.

Optional: SSE at /api/track/:tripId/sse streaming data: {lat,lng,ts}.

Booking page updates

Replace the static pickup/drop UI area with:

MapMini displayed in the booking header with skeleton until data loads.

A Track my bus live button below the map (visible only for scheduled/future trips).

Clicking the Track button opens LiveMapOverlay.

Ensure the MapMini receives stops and pickup/drop from the trip data.

Add console.log statements on:

getTripStops success

LiveMapOverlay position updates

These are required so we can check logs.

CSS / assets

Add client/src/styles/map.css:

Basic Leaflet container sizing, ensure Leaflet icons are loaded (import leaflet CSS).

.skeleton shimmer CSS.

Ensure leaflet/dist/leaflet.css is imported in MapMini.tsx or globally in client/src/main.tsx.

Acceptance criteria (automated check)

Mini map visible on booking page (not a blank area).

Map shows pickup & drop markers, stops as markers, and a polyline route.

Skeleton loader appears while trip/route/stops data is fetching.

“Track my bus live” button opens overlay and bus marker updates at least every 2s (polling) — console.logs each new position.

Modal is keyboard-accessible and closable by ESC.

Provide changed file list at the end of run and a screenshot of:

Booking page showing mini map with route (and skeleton during load).

Live overlay open with bus marker and log of position updates visible in console.

Testing steps for reviewer (paste in terminal)

Start dev server.

Open booking page for a scheduled trip: /booking/1.

Confirm skeleton shows briefly, then mini-map loads with route.

Click “Track my bus live” — overlay opens, bus marker updates; check console logs for position update.

Confirm ESC closes overlay and focus returns to Track button.

Notes / fallback

If server-side SSE is not possible on Replit, polling is fine and must be implemented.

If route coordinates are not present in DB, create a mock route generator in server/api/track that interpolates between pickup → stops → drop.

Use react-leaflet for map; it does not require an API key (uses OpenStreetMap tiles).

Deliverable format for the agent

At the end of the run return:

List of changed files (paths).

Short test log showing console outputs for position updates.

Two screenshots:

Booking page with mini-map (and skeleton briefly).

LiveMapOverlay open while tracking showing bus marker moving.